<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planejamento Financeiro 2026</title>
    <!-- Tailwind CSS para estilização rápida e responsiva -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Ícones -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        /* Ajustes finos para mobile */
        .currency-input { text-align: right; }
        .status-checkbox:checked + div {
            background-color: #d1fae5; /* Verde claro */
            text-decoration: line-through;
            opacity: 0.7;
        }
        .status-checkbox-expense:checked + div {
            background-color: #d1fae5; /* Verde claro quando pago */
            border-left: 4px solid #10b981;
        }
        .status-checkbox-expense:not(:checked) + div {
            border-left: 4px solid #ef4444; /* Vermelho quando pendente */
        }
        
        /* Spinner de carregamento */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 font-sans">

    <!-- TELA DE LOGIN -->
    <div id="login-screen" class="min-h-screen flex items-center justify-center p-4">
        <div class="bg-white p-8 rounded-lg shadow-lg w-full max-w-md">
            <h1 class="text-2xl font-bold mb-6 text-center text-blue-600">Financeiro 2026</h1>
            <p class="mb-4 text-sm text-gray-600 text-center">Faça login para sincronizar seus dados.</p>
            
            <form id="login-form" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium">E-mail</label>
                    <input type="email" id="email" class="w-full p-2 border rounded mt-1" required>
                </div>
                <div>
                    <label class="block text-sm font-medium">Senha</label>
                    <input type="password" id="password" class="w-full p-2 border rounded mt-1" required>
                </div>
                <div class="flex flex-col gap-2">
                    <button type="submit" class="w-full bg-blue-600 text-white p-2 rounded hover:bg-blue-700 transition">Entrar / Criar Conta</button>
                    <p id="auth-error" class="text-red-500 text-xs text-center hidden"></p>
                </div>
            </form>
        </div>
    </div>

    <!-- TELA DO APP (Oculta inicialmente) -->
    <div id="app-screen" class="hidden min-h-screen pb-20">
        
        <!-- HEADER / NAVEGAÇÃO DE MÊS -->
        <header class="bg-blue-600 text-white p-4 sticky top-0 z-50 shadow-md">
            <div class="max-w-4xl mx-auto flex justify-between items-center">
                <button id="prev-month" class="p-2 hover:bg-blue-700 rounded"><i class="fas fa-chevron-left"></i></button>
                <div class="text-center">
                    <h2 id="current-month-display" class="text-xl font-bold uppercase">Janeiro</h2>
                    <span id="current-year-display" class="text-xs opacity-75">2026</span>
                </div>
                <button id="next-month" class="p-2 hover:bg-blue-700 rounded"><i class="fas fa-chevron-right"></i></button>
                <button id="logout-btn" class="ml-4 text-xs bg-blue-800 p-1 rounded">Sair</button>
            </div>
        </header>

        <!-- DASHBOARD DE TOTAIS -->
        <div class="max-w-4xl mx-auto p-4">
            <div class="bg-white rounded-lg shadow p-4 mb-6 grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                <div class="col-span-2 md:col-span-1 border-b md:border-b-0 md:border-r pb-2 md:pb-0">
                    <p class="text-xs text-gray-500 uppercase">Receitas Totais</p>
                    <p id="total-income" class="text-lg font-bold text-green-600">R$ 0,00</p>
                </div>
                <div class="border-r border-gray-100">
                    <p class="text-xs text-gray-500 uppercase">Contas Pagas</p>
                    <p id="total-paid" class="text-lg font-bold text-blue-600">R$ 0,00</p>
                </div>
                <div>
                    <p class="text-xs text-gray-500 uppercase">A Pagar</p>
                    <p id="total-pending" class="text-lg font-bold text-red-500">R$ 0,00</p>
                </div>
                <div class="col-span-2 md:col-span-1 bg-gray-50 rounded p-2 mt-2 md:mt-0">
                    <p class="text-xs text-gray-500 uppercase">Saldo Previsto</p>
                    <p id="balance" class="text-xl font-bold text-gray-800">R$ 0,00</p>
                </div>
            </div>

            <!-- STATUS DE SALVAMENTO -->
            <div id="save-status" class="text-center text-xs text-gray-400 mb-4 h-4"></div>

            <!-- SEÇÃO 1: ENTRADAS -->
            <div class="bg-white rounded-lg shadow mb-6 overflow-hidden">
                <div class="bg-green-600 text-white p-3 flex justify-between items-center">
                    <h3 class="font-bold"><i class="fas fa-wallet mr-2"></i> Entradas</h3>
                    <button onclick="addItem('incomes')" class="text-sm bg-green-700 px-2 py-1 rounded hover:bg-green-800"><i class="fas fa-plus"></i></button>
                </div>
                <div id="list-incomes" class="p-2 space-y-2">
                    <!-- Items injetados via JS -->
                </div>
            </div>

            <!-- SEÇÃO 2: CONTAS FIXAS -->
            <div class="bg-white rounded-lg shadow mb-6 overflow-hidden">
                <div class="bg-gray-700 text-white p-3 flex justify-between items-center">
                    <h3 class="font-bold"><i class="fas fa-file-invoice mr-2"></i> Contas Fixas</h3>
                    <button onclick="addItem('fixed')" class="text-sm bg-gray-600 px-2 py-1 rounded hover:bg-gray-800"><i class="fas fa-plus"></i></button>
                </div>
                <div id="list-fixed" class="p-2 space-y-2">
                    <!-- Items injetados via JS -->
                </div>
            </div>

            <!-- SEÇÃO 3: CARTÃO DE CRÉDITO -->
            <div class="bg-white rounded-lg shadow mb-6 overflow-hidden">
                <div class="bg-purple-600 text-white p-3 flex justify-between items-center">
                    <h3 class="font-bold"><i class="fas fa-credit-card mr-2"></i> Cartões de Crédito</h3>
                    <button onclick="addItem('cards')" class="text-sm bg-purple-700 px-2 py-1 rounded hover:bg-purple-800"><i class="fas fa-plus"></i></button>
                </div>
                <div class="text-xs text-gray-500 px-3 pt-2 grid grid-cols-12 gap-1 text-center md:text-left">
                    <span class="col-span-4 md:col-span-3">Banco/Emissor</span>
                    <span class="col-span-3 hidden md:block">Limite</span>
                    <span class="col-span-3 md:col-span-2">Data Venc.</span>
                    <span class="col-span-3">Valor</span>
                    <span class="col-span-2 md:col-span-1">Pago?</span>
                </div>
                <div id="list-cards" class="p-2 space-y-2">
                    <!-- Items injetados via JS -->
                </div>
            </div>

            <!-- SEÇÃO 4: GASTOS GERAIS -->
            <div class="bg-white rounded-lg shadow mb-20 overflow-hidden">
                <div class="bg-orange-500 text-white p-3 flex justify-between items-center">
                    <h3 class="font-bold"><i class="fas fa-shopping-cart mr-2"></i> Gastos Gerais</h3>
                    <button onclick="addItem('general')" class="text-sm bg-orange-600 px-2 py-1 rounded hover:bg-orange-700"><i class="fas fa-plus"></i></button>
                </div>
                <div id="list-general" class="p-2 space-y-2">
                    <!-- Items injetados via JS -->
                </div>
            </div>
        </div>
    </div>

    <!-- SCRIPTS FIREBASE E LÓGICA -->
    <script type="module">
        // Importa Firebase v11
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

        // =========================================================================
        // CONFIGURAÇÃO DO FIREBASE
        // Substitua este objeto pelo que você copiou do Console do Firebase
        // =========================================================================
        const firebaseConfig = {
            apiKey: "SUA_API_KEY_AQUI",
            authDomain: "seu-projeto.firebaseapp.com",
            projectId: "seu-projeto",
            storageBucket: "seu-projeto.appspot.com",
            messagingSenderId: "123456789",
            appId: "1:123456789:web:abcdef"
        };
        // =========================================================================

        // Inicializa Firebase
        let app, auth, db;
        
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
        } catch (e) {
            console.error("Erro ao inicializar Firebase. Verifique a config.", e);
            document.body.innerHTML = `<div class='p-10 text-center text-red-600'>Erro: Configure as chaves do Firebase no código HTML (Linha ~146).</div>`;
        }

        // Variáveis de Estado
        let currentUser = null;
        let currentDate = new Date(); // Começa hoje
        let currentData = null; // Dados do mês atual
        let unsubscribeDoc = null; // Para parar de ouvir o banco quando mudar de mês
        let saveTimeout = null; // Para o debounce do salvamento

        // Elementos DOM
        const loginScreen = document.getElementById('login-screen');
        const appScreen = document.getElementById('app-screen');
        const loginForm = document.getElementById('login-form');
        const authError = document.getElementById('auth-error');

        // Nomes dos meses
        const monthNames = ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];

        // --- AUTENTICAÇÃO ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                loginScreen.classList.add('hidden');
                appScreen.classList.remove('hidden');
                loadMonthData(); // Carrega dados
            } else {
                currentUser = null;
                loginScreen.classList.remove('hidden');
                appScreen.classList.add('hidden');
                if(unsubscribeDoc) unsubscribeDoc();
            }
        });

        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            authError.classList.add('hidden');

            try {
                // Tenta logar
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                if (error.code === 'auth/user-not-found' || error.code === 'auth/invalid-credential') {
                    // Se não existe, tenta criar (simplificação para uso pessoal)
                    try {
                        await createUserWithEmailAndPassword(auth, email, password);
                    } catch (createError) {
                        authError.textContent = "Erro ao criar conta: " + createError.message;
                        authError.classList.remove('hidden');
                    }
                } else {
                    authError.textContent = "Erro no login: " + error.message;
                    authError.classList.remove('hidden');
                }
            }
        });

        document.getElementById('logout-btn').addEventListener('click', () => signOut(auth));

        // --- NAVEGAÇÃO DE DATAS ---
        document.getElementById('prev-month').addEventListener('click', () => changeMonth(-1));
        document.getElementById('next-month').addEventListener('click', () => changeMonth(1));

        function changeMonth(delta) {
            currentDate.setMonth(currentDate.getMonth() + delta);
            loadMonthData();
        }

        // --- LÓGICA DE DADOS (Firestore) ---
        function getDocId() {
            const y = currentDate.getFullYear();
            const m = String(currentDate.getMonth() + 1).padStart(2, '0');
            return `${y}_${m}`;
        }

        function loadMonthData() {
            if (!currentUser) return;
            const docId = getDocId();
            
            // Atualiza Header
            document.getElementById('current-month-display').textContent = monthNames[currentDate.getMonth()];
            document.getElementById('current-year-display').textContent = currentDate.getFullYear();

            // Desliga listener anterior
            if (unsubscribeDoc) unsubscribeDoc();

            document.getElementById('save-status').innerHTML = '<div class="loader mx-auto"></div>';

            // Ouve mudanças no documento do mês
            const userDocRef = doc(db, 'users', currentUser.uid, 'financial_data', docId);
            
            unsubscribeDoc = onSnapshot(userDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    currentData = docSnap.data();
                } else {
                    // Inicializa mês vazio se não existir
                    currentData = {
                        incomes: [{id: Date.now(), name: 'Salário', value: 0, paid: false}],
                        fixed: [{id: Date.now(), name: 'Aluguel/Condomínio', value: 0, paid: false}],
                        cards: [],
                        general: []
                    };
                }
                renderAll();
                document.getElementById('save-status').textContent = "Sincronizado";
            }, (error) => {
                console.error("Erro ao ler dados:", error);
                document.getElementById('save-status').textContent = "Erro de conexão";
            });
        }

        // --- RENDERIZAÇÃO ---
        function renderAll() {
            if (!currentData) return;
            
            renderList('incomes', currentData.incomes, renderIncomeRow);
            renderList('fixed', currentData.fixed, renderExpenseRow);
            renderList('cards', currentData.cards, renderCardRow);
            renderList('general', currentData.general, renderExpenseRow);
            
            calculateTotals();
        }

        function renderList(type, list, rowRenderer) {
            const container = document.getElementById(`list-${type}`);
            container.innerHTML = '';
            list.forEach((item, index) => {
                container.appendChild(rowRenderer(item, index, type));
            });
        }

        // Template Linha de Entrada
        function renderIncomeRow(item, index, type) {
            const div = document.createElement('div');
            div.className = "flex items-center gap-2 bg-gray-50 p-2 rounded border border-gray-200";
            div.innerHTML = `
                <input type="checkbox" class="status-checkbox w-5 h-5 text-green-600 rounded focus:ring-green-500" 
                    ${item.paid ? 'checked' : ''} onchange="updateItem('${type}', ${index}, 'paid', this.checked)">
                <div class="flex-1 grid grid-cols-3 gap-2 transition-all duration-200">
                    <input type="text" value="${item.name}" placeholder="Descrição" 
                        class="col-span-2 bg-transparent border-b border-transparent focus:border-green-500 outline-none text-sm"
                        onchange="updateItem('${type}', ${index}, 'name', this.value)">
                    <input type="number" step="0.01" value="${item.value}" placeholder="0,00" 
                        class="currency-input bg-transparent border-b border-transparent focus:border-green-500 outline-none text-sm font-semibold"
                        onchange="updateItem('${type}', ${index}, 'value', parseFloat(this.value))">
                </div>
                <button onclick="deleteItem('${type}', ${index})" class="text-gray-400 hover:text-red-500 px-2"><i class="fas fa-trash-alt"></i></button>
            `;
            return div;
        }

        // Template Linha de Despesa (Fixa e Geral)
        function renderExpenseRow(item, index, type) {
            const div = document.createElement('div');
            div.className = "flex items-center gap-0 relative";
            
            // Lógica visual: Checkbox controla a classe do container irmão
            const isPaid = item.paid;
            
            div.innerHTML = `
                <input type="checkbox" class="status-checkbox-expense absolute opacity-0 w-8 h-full z-10 cursor-pointer" 
                    ${isPaid ? 'checked' : ''} onchange="updateItem('${type}', ${index}, 'paid', this.checked)">
                
                <div class="flex-1 flex items-center gap-2 bg-white p-3 rounded shadow-sm border border-gray-100 transition-all duration-300 w-full pl-4">
                    <!-- Indicador visual de status (borda esquerda via CSS) -->
                    
                    <div class="flex-1 grid grid-cols-3 gap-2">
                        <input type="text" value="${item.name}" placeholder="Descrição" 
                            class="col-span-2 bg-transparent border-b border-gray-100 focus:border-blue-500 outline-none text-sm"
                            onchange="updateItem('${type}', ${index}, 'name', this.value)">
                        <input type="number" step="0.01" value="${item.value}" placeholder="0,00" 
                            class="currency-input bg-transparent border-b border-gray-100 focus:border-blue-500 outline-none text-sm font-semibold text-gray-700"
                            onchange="updateItem('${type}', ${index}, 'value', parseFloat(this.value))">
                    </div>
                    <div class="z-20">
                         <button onclick="deleteItem('${type}', ${index})" class="text-gray-300 hover:text-red-500 p-2"><i class="fas fa-trash-alt"></i></button>
                    </div>
                </div>
            `;
            return div;
        }

        // Template Linha de Cartão (Mais complexo)
        function renderCardRow(item, index, type) {
            const div = document.createElement('div');
            div.className = "flex items-center gap-0 relative group";
            const isPaid = item.paid;

            div.innerHTML = `
                <input type="checkbox" class="status-checkbox-expense absolute opacity-0 w-8 h-full z-10 cursor-pointer" 
                    ${isPaid ? 'checked' : ''} onchange="updateItem('${type}', ${index}, 'paid', this.checked)">
                
                <div class="flex-1 bg-white p-3 rounded shadow-sm border border-gray-100 transition-all duration-300 pl-4">
                     <div class="grid grid-cols-12 gap-2 items-center">
                        <!-- Banco -->
                        <div class="col-span-4 md:col-span-3">
                            <input type="text" value="${item.issuer || ''}" placeholder="Banco" 
                            class="w-full bg-transparent border-b border-gray-100 focus:border-purple-500 outline-none text-sm font-medium"
                            onchange="updateItem('${type}', ${index}, 'issuer', this.value)">
                        </div>
                        
                        <!-- Limite (Oculto em mobile pequeno) -->
                        <div class="hidden md:block col-span-3">
                             <input type="number" value="${item.limit || ''}" placeholder="Limite" 
                            class="w-full bg-transparent border-b border-gray-100 focus:border-purple-500 outline-none text-xs text-gray-500"
                            onchange="updateItem('${type}', ${index}, 'limit', parseFloat(this.value))">
                        </div>

                        <!-- Data -->
                        <div class="col-span-3 md:col-span-2">
                             <input type="text" value="${item.date || ''}" placeholder="Dia" 
                            class="w-full bg-transparent border-b border-gray-100 focus:border-purple-500 outline-none text-xs text-center"
                            onchange="updateItem('${type}', ${index}, 'date', this.value)">
                        </div>

                        <!-- Valor -->
                        <div class="col-span-3">
                            <input type="number" step="0.01" value="${item.value}" placeholder="0,00" 
                            class="currency-input w-full bg-transparent border-b border-gray-100 focus:border-purple-500 outline-none text-sm font-bold text-gray-700"
                            onchange="updateItem('${type}', ${index}, 'value', parseFloat(this.value))">
                        </div>

                        <!-- Botão Delete -->
                        <div class="col-span-2 md:col-span-1 text-right z-20">
                            <button onclick="deleteItem('${type}', ${index})" class="text-gray-300 hover:text-red-500"><i class="fas fa-trash-alt"></i></button>
                        </div>
                     </div>
                </div>
            `;
            return div;
        }

        // --- CÁLCULOS ---
        function calculateTotals() {
            let totalIncome = 0;
            let totalPaid = 0;
            let totalPending = 0;

            // Soma Entradas
            currentData.incomes.forEach(i => totalIncome += (i.value || 0));

            // Função helper para somar despesas
            const sumExpense = (list) => {
                list.forEach(item => {
                    const val = item.value || 0;
                    if (item.paid) totalPaid += val;
                    else totalPending += val;
                });
            };

            sumExpense(currentData.fixed);
            sumExpense(currentData.cards);
            sumExpense(currentData.general);

            // Atualiza UI
            const fmt = (v) => v.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            
            document.getElementById('total-income').textContent = fmt(totalIncome);
            document.getElementById('total-paid').textContent = fmt(totalPaid);
            document.getElementById('total-pending').textContent = fmt(totalPending);
            
            // Saldo Previsto (Entrada - (Pago + Pendente))
            const balance = totalIncome - (totalPaid + totalPending);
            const balEl = document.getElementById('balance');
            balEl.textContent = fmt(balance);
            balEl.className = `text-xl font-bold ${balance >= 0 ? 'text-blue-600' : 'text-red-600'}`;
        }

        // --- OPERAÇÕES (CRUD) ---
        
        // Expor funções para o escopo global (para o HTML onclick funcionar)
        window.addItem = (type) => {
            const newItem = { id: Date.now(), value: 0, paid: false };
            if (type === 'incomes' || type === 'fixed' || type === 'general') newItem.name = '';
            if (type === 'cards') { newItem.issuer = ''; newItem.limit = 0; newItem.date = ''; }
            
            currentData[type].push(newItem);
            renderAll(); // Re-renderiza imediatamente para UX
            saveData();
        };

        window.deleteItem = (type, index) => {
            if(confirm("Remover este item?")) {
                currentData[type].splice(index, 1);
                renderAll();
                saveData();
            }
        };

        window.updateItem = (type, index, field, value) => {
            currentData[type][index][field] = value;
            // Se for checkbox, re-renderiza para mudar a cor instantaneamente
            if(field === 'paid') renderAll(); 
            // Se for valor, apenas recalcula totais para não perder foco do input
            else calculateTotals(); 
            
            saveData();
        };

        // Salvar no Firestore com Debounce (evita excesso de escritas)
        function saveData() {
            document.getElementById('save-status').textContent = "Salvando...";
            
            if (saveTimeout) clearTimeout(saveTimeout);
            
            saveTimeout = setTimeout(async () => {
                if (!currentUser) return;
                const docId = getDocId();
                try {
                    await setDoc(doc(db, 'users', currentUser.uid, 'financial_data', docId), currentData);
                    document.getElementById('save-status').textContent = "Alterações salvas.";
                    setTimeout(() => { document.getElementById('save-status').textContent = "Sincronizado"; }, 2000);
                } catch (e) {
                    console.error("Erro ao salvar", e);
                    document.getElementById('save-status').textContent = "Erro ao salvar!";
                }
            }, 1000); // Espera 1 segundo após a última digitação
        }

    </script>
</body>
</html>