<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planejamento Financeiro 2026</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Ícones -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        .currency-input { text-align: right; }
        
        /* Checkbox customizado para despesas - AUMENTADO PARA TOUCH */
        .status-checkbox-expense:checked + div {
            background-color: #d1fae5; /* Verde claro quando pago */
            border-left: 12px solid #10b981; /* Borda mais larga */
        }
        .status-checkbox-expense:not(:checked) + div {
            border-left: 12px solid #ef4444; /* Vermelho quando pendente - Borda mais larga */
        }
        
        /* Área de toque expandida */
        .touch-area {
            width: 60px; /* Largura clicável aumentada */
        }

        /* Spinner */
        .loader {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 font-sans pb-10">

    <!-- TELA DE LOGIN (Simplificada) -->
    <div id="login-screen" class="min-h-screen flex items-center justify-center p-4">
        <div class="bg-white p-8 rounded-lg shadow-lg w-full max-w-sm text-center">
            <h1 class="text-2xl font-bold mb-2 text-blue-600">Financeiro 2026</h1>
            <p class="text-gray-500 mb-8 text-sm">Controle suas finanças pessoais</p>
            
            <button id="google-login-btn" class="w-full bg-white border border-gray-300 text-gray-700 p-3 rounded-lg hover:bg-gray-50 transition flex items-center justify-center gap-3 font-bold shadow-sm">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-6 h-6" alt="Google">
                Entrar com Google
            </button>

            <p id="auth-error" class="text-red-500 text-xs mt-4 hidden"></p>
        </div>
    </div>

    <!-- TELA DO APP -->
    <div id="app-screen" class="hidden min-h-screen pb-16">
        
        <!-- HEADER -->
        <header class="bg-blue-600 text-white p-4 sticky top-0 z-50 shadow-md">
            <div class="max-w-4xl mx-auto flex justify-between items-center">
                <button id="prev-month" class="p-2 hover:bg-blue-700 rounded"><i class="fas fa-chevron-left"></i></button>
                <div class="text-center">
                    <h2 id="current-month-display" class="text-xl font-bold uppercase">Janeiro</h2>
                    <span id="current-year-display" class="text-xs opacity-75">2026</span>
                </div>
                <button id="next-month" class="p-2 hover:bg-blue-700 rounded"><i class="fas fa-chevron-right"></i></button>
                <button id="logout-btn" class="ml-4 text-xs bg-blue-800 p-2 rounded hover:bg-blue-900"><i class="fas fa-sign-out-alt"></i></button>
            </div>
        </header>

        <!-- DASHBOARD -->
        <div class="max-w-4xl mx-auto p-4">
            <div class="bg-white rounded-lg shadow p-4 mb-6 grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                <div class="col-span-2 md:col-span-1 border-b md:border-b-0 md:border-r pb-2 md:pb-0">
                    <p class="text-xs text-gray-500 uppercase">Receitas Totais</p>
                    <p id="total-income" class="text-lg font-bold text-green-600">R$ 0,00</p>
                </div>
                <div class="border-r border-gray-100">
                    <p class="text-xs text-gray-500 uppercase">Contas Pagas</p>
                    <p id="total-paid" class="text-lg font-bold text-blue-600">R$ 0,00</p>
                </div>
                <div>
                    <p class="text-xs text-gray-500 uppercase">A Pagar</p>
                    <p id="total-pending" class="text-lg font-bold text-red-500">R$ 0,00</p>
                </div>
                <div class="col-span-2 md:col-span-1 bg-gray-50 rounded p-2 mt-2 md:mt-0">
                    <p class="text-xs text-gray-500 uppercase">Saldo Previsto</p>
                    <p id="balance" class="text-xl font-bold text-gray-800">R$ 0,00</p>
                </div>
            </div>

            <!-- SEÇÃO 1: ENTRADAS -->
            <div class="bg-white rounded-lg shadow mb-6 overflow-hidden">
                <div class="bg-green-600 text-white p-3 flex justify-between items-center">
                    <h3 class="font-bold"><i class="fas fa-wallet mr-2"></i> Entradas</h3>
                    <button onclick="addItem('incomes')" class="text-sm bg-green-700 px-3 py-1 rounded hover:bg-green-800 font-bold"><i class="fas fa-plus"></i></button>
                </div>
                <div id="list-incomes" class="p-2 space-y-2"></div>
            </div>

            <!-- SEÇÃO 2: CONTAS FIXAS -->
            <div class="bg-white rounded-lg shadow mb-6 overflow-hidden">
                <div class="bg-gray-700 text-white p-3 flex justify-between items-center">
                    <h3 class="font-bold"><i class="fas fa-file-invoice mr-2"></i> Contas Fixas</h3>
                    <button onclick="addItem('fixed')" class="text-sm bg-gray-600 px-3 py-1 rounded hover:bg-gray-800 font-bold"><i class="fas fa-plus"></i></button>
                </div>
                <div id="list-fixed" class="p-2 space-y-2"></div>
            </div>

            <!-- SEÇÃO 3: CARTÃO DE CRÉDITO -->
            <div class="bg-white rounded-lg shadow mb-6 overflow-hidden">
                <div class="bg-purple-600 text-white p-3 flex justify-between items-center">
                    <h3 class="font-bold"><i class="fas fa-credit-card mr-2"></i> Cartões de Crédito</h3>
                    <button onclick="addItem('cards')" class="text-sm bg-purple-700 px-3 py-1 rounded hover:bg-purple-800 font-bold"><i class="fas fa-plus"></i></button>
                </div>
                <div class="text-xs text-gray-500 px-3 pt-2 flex justify-between px-12">
                    <span>Cartão</span>
                    <span class="mr-12">Valor (R$)</span>
                </div>
                <div id="list-cards" class="p-2 space-y-2"></div>
            </div>

            <!-- SEÇÃO 4: GASTOS GERAIS -->
            <div class="bg-white rounded-lg shadow mb-6 overflow-hidden">
                <div class="bg-orange-500 text-white p-3 flex justify-between items-center">
                    <h3 class="font-bold"><i class="fas fa-shopping-cart mr-2"></i> Gastos Gerais</h3>
                    <button onclick="addItem('general')" class="text-sm bg-orange-600 px-3 py-1 rounded hover:bg-orange-700 font-bold"><i class="fas fa-plus"></i></button>
                </div>
                <div id="list-general" class="p-2 space-y-2"></div>
            </div>
        </div>
    </div>

    <!-- RODAPÉ DE STATUS -->
    <footer class="fixed bottom-0 left-0 w-full bg-white border-t border-gray-200 p-2 text-center text-xs text-gray-500 z-50 shadow-[0_-2px_4px_rgba(0,0,0,0.05)]">
        <span id="save-status">Aguardando...</span>
    </footer>

    <!-- SCRIPTS -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDWRt1BzPdFXHjRE47gWN5LHfzXjAKMQn4",
            authDomain: "planner-financeiro-casal-65fcc.firebaseapp.com",
            projectId: "planner-financeiro-casal-65fcc",
            storageBucket: "planner-financeiro-casal-65fcc.firebasestorage.app",
            messagingSenderId: "292357191944",
            appId: "1:292357191944:web:cef04d637a764aaa9314bd"
        };

        let app, auth, db;
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
        } catch (e) { console.error("Erro Firebase:", e); }

        let currentUser = null;
        let currentDate = new Date();
        let currentData = null;
        let unsubscribeDoc = null;
        let saveTimeout = null;

        const loginScreen = document.getElementById('login-screen');
        const appScreen = document.getElementById('app-screen');
        const authError = document.getElementById('auth-error');
        const monthNames = ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];

        // --- AUTH ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                loginScreen.classList.add('hidden');
                appScreen.classList.remove('hidden');
                loadMonthData();
            } else {
                currentUser = null;
                loginScreen.classList.remove('hidden');
                appScreen.classList.add('hidden');
                if(unsubscribeDoc) unsubscribeDoc();
            }
        });

        document.getElementById('google-login-btn').addEventListener('click', async () => {
            const provider = new GoogleAuthProvider();
            try {
                await signInWithPopup(auth, provider);
            } catch (error) {
                authError.textContent = "Erro Google: " + error.message;
                authError.classList.remove('hidden');
            }
        });

        document.getElementById('logout-btn').addEventListener('click', () => signOut(auth));

        // --- NAVEGAÇÃO ---
        document.getElementById('prev-month').addEventListener('click', () => changeMonth(-1));
        document.getElementById('next-month').addEventListener('click', () => changeMonth(1));

        function changeMonth(delta) {
            currentDate.setMonth(currentDate.getMonth() + delta);
            loadMonthData();
        }

        // --- DADOS ---
        function getDocId() {
            const y = currentDate.getFullYear();
            const m = String(currentDate.getMonth() + 1).padStart(2, '0');
            return `${y}_${m}`;
        }

        function loadMonthData() {
            if (!currentUser) return;
            const docId = getDocId();
            
            document.getElementById('current-month-display').textContent = monthNames[currentDate.getMonth()];
            document.getElementById('current-year-display').textContent = currentDate.getFullYear();

            if (unsubscribeDoc) unsubscribeDoc();
            document.getElementById('save-status').innerHTML = '<div class="loader"></div> Sincronizando...';

            const userDocRef = doc(db, 'users', currentUser.uid, 'financial_data', docId);
            
            unsubscribeDoc = onSnapshot(userDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    currentData = docSnap.data();
                    if (!currentData.incomes) currentData.incomes = [];
                    if (!currentData.fixed) currentData.fixed = [];
                    if (!currentData.cards) currentData.cards = [];
                    if (!currentData.general) currentData.general = [];
                } else {
                    currentData = { incomes: [], fixed: [], cards: [], general: [] };
                    if (currentData.incomes.length === 0) currentData.incomes.push({id: Date.now(), name: 'Salário', value: 0});
                    if (currentData.fixed.length === 0) currentData.fixed.push({id: Date.now()+1, name: 'Aluguel', value: 0, paid: false});
                }
                renderAll();
                document.getElementById('save-status').innerHTML = '<i class="fas fa-check text-green-500"></i> Sincronizado';
            });
        }

        // --- RENDER ---
        function renderAll() {
            if (!currentData) return;
            renderList('incomes', currentData.incomes, renderIncomeRow);
            renderList('fixed', currentData.fixed, renderExpenseRow);
            renderList('cards', currentData.cards, renderCardRow);
            renderList('general', currentData.general, renderExpenseRow);
            calculateTotals();
        }

        function renderList(type, list, rowRenderer) {
            const container = document.getElementById(`list-${type}`);
            container.innerHTML = '';
            list.forEach((item, index) => {
                container.appendChild(rowRenderer(item, index, type));
            });
        }

        // 1. ENTRADAS
        function renderIncomeRow(item, index, type) {
            const div = document.createElement('div');
            div.className = "flex items-center gap-2 bg-gray-50 p-2 rounded border border-gray-200";
            div.innerHTML = `
                <div class="flex-1 grid grid-cols-3 gap-2">
                    <input type="text" value="${item.name}" placeholder="Descrição" 
                        class="col-span-2 bg-transparent border-b border-transparent focus:border-green-500 outline-none text-sm pl-2"
                        onchange="updateItem('${type}', ${index}, 'name', this.value)">
                    
                    <div class="flex items-center border-b border-transparent focus-within:border-green-500">
                        <span class="text-xs text-gray-500 mr-1">R$</span>
                        <input type="number" step="0.01" value="${item.value}" placeholder="0,00" 
                            class="w-full bg-transparent outline-none text-sm font-semibold text-right"
                            onchange="updateItem('${type}', ${index}, 'value', parseFloat(this.value))">
                    </div>
                </div>
                <button onclick="deleteItem('${type}', ${index})" class="text-gray-400 hover:text-red-500 px-2"><i class="fas fa-trash-alt"></i></button>
            `;
            return div;
        }

        // 2. DESPESAS (Com checkbox largo)
        function renderExpenseRow(item, index, type) {
            const div = document.createElement('div');
            div.className = "flex items-center gap-0 relative";
            const isPaid = item.paid;
            
            div.innerHTML = `
                <!-- Checkbox oculto mas com área de toque aumentada -->
                <input type="checkbox" class="status-checkbox-expense absolute opacity-0 touch-area h-full z-10 cursor-pointer" 
                    ${isPaid ? 'checked' : ''} onchange="updateItem('${type}', ${index}, 'paid', this.checked)">
                
                <div class="flex-1 flex items-center gap-2 bg-white p-3 rounded shadow-sm border border-gray-100 transition-all duration-300 w-full pl-6">
                    <div class="flex-1 grid grid-cols-3 gap-2">
                        <input type="text" value="${item.name}" placeholder="Descrição" 
                            class="col-span-2 bg-transparent border-b border-gray-100 focus:border-blue-500 outline-none text-sm"
                            onchange="updateItem('${type}', ${index}, 'name', this.value)">
                        
                        <div class="flex items-center border-b border-gray-100 focus-within:border-blue-500">
                            <span class="text-xs text-gray-500 mr-1">R$</span>
                            <input type="number" step="0.01" value="${item.value}" placeholder="0,00" 
                                class="w-full bg-transparent outline-none text-sm font-semibold text-gray-700 text-right"
                                onchange="updateItem('${type}', ${index}, 'value', parseFloat(this.value))">
                        </div>
                    </div>
                    <div class="z-20">
                         <button onclick="deleteItem('${type}', ${index})" class="text-gray-300 hover:text-red-500 p-2"><i class="fas fa-trash-alt"></i></button>
                    </div>
                </div>
            `;
            return div;
        }

        // 3. CARTÕES (Com checkbox largo)
        function renderCardRow(item, index, type) {
            const div = document.createElement('div');
            div.className = "flex items-center gap-0 relative group";
            const isPaid = item.paid;

            div.innerHTML = `
                <input type="checkbox" class="status-checkbox-expense absolute opacity-0 touch-area h-full z-10 cursor-pointer" 
                    ${isPaid ? 'checked' : ''} onchange="updateItem('${type}', ${index}, 'paid', this.checked)">
                
                <div class="flex-1 bg-white p-3 rounded shadow-sm border border-gray-100 transition-all duration-300 pl-6 flex items-center gap-2">
                     <div class="flex-1 grid grid-cols-3 gap-2">
                        <input type="text" value="${item.issuer || ''}" placeholder="Nome do Cartão" 
                            class="col-span-2 bg-transparent border-b border-gray-100 focus:border-purple-500 outline-none text-sm font-medium"
                            onchange="updateItem('${type}', ${index}, 'issuer', this.value)">
                        
                        <div class="flex items-center border-b border-gray-100 focus-within:border-purple-500">
                            <span class="text-xs text-gray-500 mr-1">R$</span>
                            <input type="number" step="0.01" value="${item.value}" placeholder="0,00" 
                                class="w-full bg-transparent outline-none text-sm font-bold text-gray-700 text-right"
                                onchange="updateItem('${type}', ${index}, 'value', parseFloat(this.value))">
                        </div>
                     </div>
                     <div class="z-20">
                        <button onclick="deleteItem('${type}', ${index})" class="text-gray-300 hover:text-red-500 p-2"><i class="fas fa-trash-alt"></i></button>
                     </div>
                </div>
            `;
            return div;
        }

        function calculateTotals() {
            let totalIncome = 0;
            let totalPaid = 0;
            let totalPending = 0;

            currentData.incomes.forEach(i => totalIncome += (i.value || 0));

            const sumExpense = (list) => {
                list.forEach(item => {
                    const val = item.value || 0;
                    if (item.paid) totalPaid += val;
                    else totalPending += val;
                });
            };

            sumExpense(currentData.fixed);
            sumExpense(currentData.cards);
            sumExpense(currentData.general);

            const fmt = (v) => v.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            
            document.getElementById('total-income').textContent = fmt(totalIncome);
            document.getElementById('total-paid').textContent = fmt(totalPaid);
            document.getElementById('total-pending').textContent = fmt(totalPending);
            
            const balance = totalIncome - (totalPaid + totalPending);
            const balEl = document.getElementById('balance');
            balEl.textContent = fmt(balance);
            balEl.className = `text-xl font-bold ${balance >= 0 ? 'text-blue-600' : 'text-red-600'}`;
        }

        window.addItem = (type) => {
            const newItem = { id: Date.now(), value: 0, paid: false };
            if (type === 'incomes') { delete newItem.paid; newItem.name = ''; }
            else if (type === 'cards') { newItem.issuer = ''; }
            else { newItem.name = ''; }
            
            currentData[type].push(newItem);
            renderAll();
            saveData();
        };

        window.deleteItem = (type, index) => {
            if(confirm("Remover item?")) {
                currentData[type].splice(index, 1);
                renderAll();
                saveData();
            }
        };

        window.updateItem = (type, index, field, value) => {
            currentData[type][index][field] = value;
            if(field === 'paid') renderAll(); 
            else calculateTotals(); 
            saveData();
        };

        function saveData() {
            document.getElementById('save-status').innerHTML = '<div class="loader"></div> Salvando...';
            if (saveTimeout) clearTimeout(saveTimeout);
            saveTimeout = setTimeout(async () => {
                if (!currentUser) return;
                const docId = getDocId();
                try {
                    await setDoc(doc(db, 'users', currentUser.uid, 'financial_data', docId), currentData);
                    document.getElementById('save-status').innerHTML = '<i class="fas fa-check text-green-500"></i> Sincronizado';
                } catch (e) {
                    console.error(e);
                    document.getElementById('save-status').textContent = "Erro ao salvar!";
                }
            }, 1000);
        }
    </script>
</body>
</html>
