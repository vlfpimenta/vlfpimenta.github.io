<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <title>Vini e Duda - Planejamento Financeiro</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'media', // Ativa modo escuro baseado no sistema
            theme: {
                extend: {
                    colors: {
                        gray: {
                            850: '#1f2937',
                            900: '#111827',
                            950: '#030712',
                        }
                    }
                }
            }
        }
    </script>
    <!-- Ícones -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        .currency-input { text-align: right; }
        
        /* Background com Imagem Aleatória */
        body {
            background-image: url('https://picsum.photos/1920/1080?grayscale');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            background-repeat: no-repeat;
        }
        
        /* Overlay padrão (Modo Claro) */
        body::before {
            content: "";
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.4);
            z-index: -1;
            transition: background 0.3s ease;
        }

        /* Overlay mais escuro (Modo Escuro) */
        @media (prefers-color-scheme: dark) {
            body::before {
                background: rgba(0, 0, 0, 0.75); /* Mais escuro para contraste */
            }
        }

        /* Checkbox customizado para despesas - AUMENTADO PARA TOUCH */
        .status-checkbox-expense:checked + div {
            background-color: #d1fae5;
            border-left: 12px solid #10b981;
        }
        /* Ajuste do checkbox pago no dark mode */
        @media (prefers-color-scheme: dark) {
            .status-checkbox-expense:checked + div {
                background-color: #064e3b; /* Verde muito escuro */
                border-left: 12px solid #34d399;
            }
        }

        .status-checkbox-expense:not(:checked) + div {
            border-left: 12px solid #ef4444;
        }

        
        /* Área de toque expandida */
        .touch-area {
            width: 60px; 
        }

        /* Spinner */
        .loader {
            border: 3px solid #4b5563; /* Cinza escuro */
            border-top: 3px solid #60a5fa; /* Azul claro */
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="text-gray-800 dark:text-gray-100 font-sans pb-10">

    <!-- TELA DE LOGIN -->
    <div id="login-screen" class="min-h-screen flex items-center justify-center p-4">
        <div class="bg-white/95 dark:bg-gray-900/95 backdrop-blur-sm p-8 rounded-lg shadow-2xl w-full max-w-md text-center border border-gray-100 dark:border-gray-800 transition-colors duration-300">
            <h1 class="text-2xl font-bold mb-2 text-blue-600 dark:text-blue-400">Vini e Duda</h1>
            <h2 class="text-lg font-semibold text-gray-700 dark:text-gray-300 mb-6">Planejamento Financeiro</h2>
            <p class="text-gray-500 dark:text-gray-400 mb-8 text-sm">Controle familiar compartilhado</p>
            
            <button id="google-login-btn" class="w-full bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-white p-3 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition flex items-center justify-center gap-3 font-bold shadow-sm">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-6 h-6" alt="Google">
                Entrar com Google
            </button>

            <!-- Área de Erro -->
            <div id="auth-error-container" class="hidden mt-6 bg-red-50 dark:bg-red-900/30 border border-red-200 dark:border-red-800 rounded p-3 text-left">
                <p class="text-red-600 dark:text-red-400 font-bold text-xs mb-1"><i class="fas fa-exclamation-circle"></i> Erro de Login:</p>
                <p id="auth-error-msg" class="text-red-500 dark:text-red-300 text-xs mb-2 break-words">...</p>
                
                <div id="domain-help" class="hidden text-xs text-gray-600 dark:text-gray-400 border-t border-red-100 dark:border-red-800 pt-2 mt-2">
                    <p class="font-bold">Como resolver (Domínio não autorizado):</p>
                    <ol class="list-decimal ml-4 mt-1 space-y-1">
                        <li>Acesse o <a href="https://console.firebase.google.com/" target="_blank" class="text-blue-600 dark:text-blue-400 underline">Console do Firebase</a>.</li>
                        <li>Vá em <strong>Authentication</strong> > <strong>Settings</strong> > <strong>Authorized domains</strong>.</li>
                        <li>Adicione o domínio atual.</li>
                    </ol>
                </div>
            </div>
        </div>
    </div>

    <!-- TELA DO APP -->
    <div id="app-screen" class="hidden min-h-screen pb-16">
        
        <!-- HEADER -->
        <header class="bg-blue-600/90 dark:bg-blue-900/90 backdrop-blur text-white p-3 sticky top-0 z-50 shadow-md border-b border-blue-500 dark:border-blue-800 transition-colors duration-300">
            <div class="max-w-4xl mx-auto flex justify-between items-center">
                <button id="prev-month" class="p-2 hover:bg-blue-700 dark:hover:bg-blue-800 rounded w-10 h-10 flex items-center justify-center"><i class="fas fa-chevron-left"></i></button>
                
                <div class="text-center flex-1">
                    <h2 id="current-month-display" class="text-lg md:text-xl font-bold uppercase leading-none">Janeiro</h2>
                    <span id="current-year-display" class="text-[10px] md:text-xs opacity-75">2026</span>
                </div>

                <div class="flex items-center gap-2">
                    <button id="next-month" class="p-2 hover:bg-blue-700 dark:hover:bg-blue-800 rounded w-10 h-10 flex items-center justify-center mr-2"><i class="fas fa-chevron-right"></i></button>
                    
                    <div class="flex items-center gap-2 border-l border-blue-500 dark:border-blue-700 pl-3">
                        <div class="hidden md:block text-right leading-tight">
                            <p id="user-name-display" class="text-xs font-bold text-white">Usuário</p>
                            <p class="text-[9px] text-blue-200">Vini e Duda</p>
                        </div>
                        <img id="user-photo-display" src="" alt="User" class="w-8 h-8 rounded-full border-2 border-blue-300 bg-blue-800 hidden">
                        
                        <button id="logout-btn" class="text-xs text-blue-200 hover:text-white p-1 ml-1" title="Sair">
                            <i class="fas fa-sign-out-alt fa-lg"></i>
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- DASHBOARD -->
        <div class="max-w-4xl mx-auto p-4">
            <div class="bg-white/95 dark:bg-gray-800/95 backdrop-blur-sm rounded-lg shadow-lg p-4 mb-6 grid grid-cols-2 md:grid-cols-4 gap-4 text-center border border-transparent dark:border-gray-700 transition-colors duration-300">
                <div class="col-span-2 md:col-span-1 border-b md:border-b-0 md:border-r border-gray-200 dark:border-gray-600 pb-2 md:pb-0">
                    <p class="text-xs text-gray-500 dark:text-gray-400 uppercase">Receitas Totais</p>
                    <p id="total-income" class="text-lg font-bold text-green-600 dark:text-green-400">R$ 0,00</p>
                </div>
                <div class="border-r border-gray-200 dark:border-gray-600">
                    <p class="text-xs text-gray-500 dark:text-gray-400 uppercase">Contas Pagas</p>
                    <p id="total-paid" class="text-lg font-bold text-blue-600 dark:text-blue-400">R$ 0,00</p>
                </div>
                <div>
                    <p class="text-xs text-gray-500 dark:text-gray-400 uppercase">A Pagar</p>
                    <p id="total-pending" class="text-lg font-bold text-red-500 dark:text-red-400">R$ 0,00</p>
                </div>
                <div class="col-span-2 md:col-span-1 bg-gray-50 dark:bg-gray-700 rounded p-2 mt-2 md:mt-0">
                    <p class="text-xs text-gray-500 dark:text-gray-300 uppercase">Saldo Previsto</p>
                    <p id="balance" class="text-xl font-bold text-gray-800 dark:text-white">R$ 0,00</p>
                </div>
            </div>

            <!-- SEÇÃO 1: ENTRADAS -->
            <div class="bg-white/95 dark:bg-gray-800/95 backdrop-blur-sm rounded-lg shadow-lg mb-6 overflow-hidden border border-transparent dark:border-gray-700">
                <div class="bg-green-600 dark:bg-green-800 text-white p-3 flex justify-between items-center">
                    <h3 class="font-bold"><i class="fas fa-wallet mr-2"></i> Entradas</h3>
                    <button onclick="addItem('incomes')" class="text-sm bg-green-700 dark:bg-green-900 px-3 py-1 rounded hover:bg-green-800 dark:hover:bg-green-950 font-bold border border-green-600 dark:border-green-700"><i class="fas fa-plus"></i></button>
                </div>
                <div id="list-incomes" class="p-2 space-y-2"></div>
            </div>

            <!-- SEÇÃO 2: CONTAS FIXAS -->
            <div class="bg-white/95 dark:bg-gray-800/95 backdrop-blur-sm rounded-lg shadow-lg mb-6 overflow-hidden border border-transparent dark:border-gray-700">
                <div class="bg-gray-700 dark:bg-gray-900 text-white p-3 flex justify-between items-center">
                    <h3 class="font-bold"><i class="fas fa-file-invoice mr-2"></i> Contas Fixas</h3>
                    <button onclick="addItem('fixed')" class="text-sm bg-gray-600 dark:bg-gray-800 px-3 py-1 rounded hover:bg-gray-800 dark:hover:bg-gray-950 font-bold border border-gray-600 dark:border-gray-700"><i class="fas fa-plus"></i></button>
                </div>
                <div id="list-fixed" class="p-2 space-y-2"></div>
            </div>

            <!-- SEÇÃO 3: CARTÃO DE CRÉDITO -->
            <div class="bg-white/95 dark:bg-gray-800/95 backdrop-blur-sm rounded-lg shadow-lg mb-6 overflow-hidden border border-transparent dark:border-gray-700">
                <div class="bg-purple-600 dark:bg-purple-800 text-white p-3 flex justify-between items-center">
                    <h3 class="font-bold"><i class="fas fa-credit-card mr-2"></i> Cartões de Crédito</h3>
                    <button onclick="addItem('cards')" class="text-sm bg-purple-700 dark:bg-purple-900 px-3 py-1 rounded hover:bg-purple-800 dark:hover:bg-purple-950 font-bold border border-purple-600 dark:border-purple-700"><i class="fas fa-plus"></i></button>
                </div>
                <div class="text-xs text-gray-500 dark:text-gray-400 px-3 pt-2 flex justify-between px-12">
                    <span>Cartão</span>
                    <span class="mr-12">Valor (R$)</span>
                </div>
                <div id="list-cards" class="p-2 space-y-2"></div>
            </div>

            <!-- SEÇÃO 4: GASTOS GERAIS -->
            <div class="bg-white/95 dark:bg-gray-800/95 backdrop-blur-sm rounded-lg shadow-lg mb-6 overflow-hidden border border-transparent dark:border-gray-700">
                <div class="bg-orange-500 dark:bg-orange-800 text-white p-3 flex justify-between items-center">
                    <h3 class="font-bold"><i class="fas fa-shopping-cart mr-2"></i> Gastos Gerais</h3>
                    <button onclick="addItem('general')" class="text-sm bg-orange-600 dark:bg-orange-900 px-3 py-1 rounded hover:bg-orange-700 dark:hover:bg-orange-950 font-bold border border-orange-600 dark:border-orange-700"><i class="fas fa-plus"></i></button>
                </div>
                <div id="list-general" class="p-2 space-y-2"></div>
            </div>
        </div>
    </div>

    <!-- RODAPÉ DE STATUS (Sempre Escuro) -->
    <footer class="fixed bottom-0 left-0 w-full bg-gray-900 text-white border-t border-gray-800 p-2 text-center text-xs text-gray-400 z-50 shadow-lg">
        <span id="save-status">Aguardando...</span>
    </footer>

    <!-- SCRIPTS -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDWRt1BzPdFXHjRE47gWN5LHfzXjAKMQn4",
            authDomain: "planner-financeiro-casal-65fcc.firebaseapp.com",
            projectId: "planner-financeiro-casal-65fcc",
            storageBucket: "planner-financeiro-casal-65fcc.firebasestorage.app",
            messagingSenderId: "292357191944",
            appId: "1:292357191944:web:cef04d637a764aaa9314bd"
        };

        let app, auth, db;
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
        } catch (e) { console.error("Erro Firebase:", e); }

        let currentUser = null;
        let currentDate = new Date();
        let currentData = null;
        let unsubscribeDoc = null;
        let saveTimeout = null;

        const loginScreen = document.getElementById('login-screen');
        const appScreen = document.getElementById('app-screen');
        const authErrorContainer = document.getElementById('auth-error-container');
        const authErrorMsg = document.getElementById('auth-error-msg');
        const domainHelp = document.getElementById('domain-help');
        const monthNames = ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];

        // --- AUTH ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                updateUserProfile(user);
                loginScreen.classList.add('hidden');
                appScreen.classList.remove('hidden');
                loadMonthData();
            } else {
                currentUser = null;
                loginScreen.classList.remove('hidden');
                appScreen.classList.add('hidden');
                if(unsubscribeDoc) unsubscribeDoc();
            }
        });

        function updateUserProfile(user) {
            const nameDisplay = document.getElementById('user-name-display');
            const photoDisplay = document.getElementById('user-photo-display');
            
            if (user.displayName) {
                const firstName = user.displayName.split(' ')[0];
                nameDisplay.textContent = firstName;
            } else {
                nameDisplay.textContent = user.email.split('@')[0];
            }

            if (user.photoURL) {
                photoDisplay.src = user.photoURL;
                photoDisplay.classList.remove('hidden');
            } else {
                photoDisplay.classList.add('hidden');
            }
        }

        document.getElementById('google-login-btn').addEventListener('click', async () => {
            const provider = new GoogleAuthProvider();
            authErrorContainer.classList.add('hidden');
            domainHelp.classList.add('hidden');

            try {
                await signInWithPopup(auth, provider);
            } catch (error) {
                console.error("Erro Login:", error);
                authErrorMsg.textContent = error.message;
                authErrorContainer.classList.remove('hidden');

                if (error.code === 'auth/unauthorized-domain') {
                    domainHelp.classList.remove('hidden');
                }
            }
        });

        document.getElementById('logout-btn').addEventListener('click', () => signOut(auth));

        // --- NAVEGAÇÃO ---
        document.getElementById('prev-month').addEventListener('click', () => changeMonth(-1));
        document.getElementById('next-month').addEventListener('click', () => changeMonth(1));

        function changeMonth(delta) {
            currentDate.setMonth(currentDate.getMonth() + delta);
            loadMonthData();
        }

        // --- DADOS ---
        function getDocId() {
            const y = currentDate.getFullYear();
            const m = String(currentDate.getMonth() + 1).padStart(2, '0');
            return `${y}_${m}`;
        }

        function loadMonthData() {
            if (!currentUser) return;
            const docId = getDocId();
            
            document.getElementById('current-month-display').textContent = monthNames[currentDate.getMonth()];
            document.getElementById('current-year-display').textContent = currentDate.getFullYear();

            if (unsubscribeDoc) unsubscribeDoc();
            document.getElementById('save-status').innerHTML = '<div class="loader"></div> Sincronizando...';

            const userDocRef = doc(db, 'monthly_data', docId);
            
            unsubscribeDoc = onSnapshot(userDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    currentData = docSnap.data();
                    if (!currentData.incomes) currentData.incomes = [];
                    if (!currentData.fixed) currentData.fixed = [];
                    if (!currentData.cards) currentData.cards = [];
                    if (!currentData.general) currentData.general = [];
                } else {
                    currentData = { incomes: [], fixed: [], cards: [], general: [] };
                    if (currentData.incomes.length === 0) addItem('incomes', false);
                    if (currentData.fixed.length === 0) addItem('fixed', false);
                }
                renderAll();
                document.getElementById('save-status').innerHTML = '<i class="fas fa-check text-green-500"></i> Sincronizado';
            }, (error) => {
                if (error.code === 'permission-denied') {
                    document.getElementById('save-status').innerHTML = '<span class="text-red-500 font-bold">Erro: Permissão negada! Verifique as Regras no Firebase.</span>';
                }
            });
        }

        // --- RENDER ---
        function renderAll() {
            if (!currentData) return;
            renderList('incomes', currentData.incomes, renderIncomeRow);
            renderList('fixed', currentData.fixed, renderExpenseRow);
            renderList('cards', currentData.cards, renderCardRow);
            renderList('general', currentData.general, renderExpenseRow);
            calculateTotals();
        }

        function renderList(type, list, rowRenderer) {
            const container = document.getElementById(`list-${type}`);
            container.innerHTML = '';
            list.forEach((item, index) => {
                container.appendChild(rowRenderer(item, index, type));
            });
        }

        function getAuthorLabel(item) {
            let label = "";
            if (item.createdBy) {
                const name = item.createdBy.split(' ')[0];
                label = `Criado por: ${name}`;
            }
            if (item.lastEditedBy && item.lastEditedBy !== item.createdBy) {
                const editName = item.lastEditedBy.split(' ')[0];
                label = `Edit: ${editName}`;
            }
            return label ? `<p class="text-[10px] text-gray-400 dark:text-gray-500 mt-0.5 truncate"><i class="fas fa-user-edit text-[8px] mr-1"></i>${label}</p>` : '';
        }

        // 1. ENTRADAS
        function renderIncomeRow(item, index, type) {
            const div = document.createElement('div');
            div.className = "flex items-center gap-2 bg-gray-50 dark:bg-gray-800 p-2 rounded border border-gray-200 dark:border-gray-700 transition-colors";
            div.innerHTML = `
                <div class="flex-1 grid grid-cols-3 gap-2">
                    <div class="col-span-2">
                        <input type="text" value="${item.name}" placeholder="Descrição" 
                            class="w-full bg-transparent border-b border-transparent focus:border-green-500 outline-none text-sm pl-2 dark:text-gray-200 placeholder-gray-400"
                            onchange="updateItem('${type}', ${index}, 'name', this.value)">
                        ${getAuthorLabel(item)}
                    </div>
                    
                    <div class="flex items-start border-b border-transparent focus-within:border-green-500">
                        <span class="text-xs text-gray-500 dark:text-gray-400 mr-1 mt-1">R$</span>
                        <input type="number" inputmode="decimal" step="0.01" value="${item.value}" placeholder="0,00" 
                            class="w-full bg-transparent outline-none text-sm font-semibold text-right dark:text-gray-100 placeholder-gray-400"
                            onchange="updateItem('${type}', ${index}, 'value', parseFloat(this.value))">
                    </div>
                </div>
                <button onclick="deleteItem('${type}', ${index})" class="text-gray-400 dark:text-gray-500 hover:text-red-500 dark:hover:text-red-400 px-2"><i class="fas fa-trash-alt"></i></button>
            `;
            return div;
        }

        // 2. DESPESAS
        function renderExpenseRow(item, index, type) {
            const div = document.createElement('div');
            div.className = "flex items-center gap-0 relative";
            const isPaid = item.paid;
            
            div.innerHTML = `
                <input type="checkbox" class="status-checkbox-expense absolute opacity-0 touch-area h-full z-10 cursor-pointer" 
                    ${isPaid ? 'checked' : ''} onchange="updateItem('${type}', ${index}, 'paid', this.checked)">
                
                <div class="flex-1 flex items-center gap-2 bg-white dark:bg-gray-800 p-3 rounded shadow-sm border border-gray-100 dark:border-gray-700 transition-colors duration-300 w-full pl-6">
                    <div class="flex-1 grid grid-cols-3 gap-2">
                        <div class="col-span-2">
                            <input type="text" value="${item.name}" placeholder="Descrição" 
                                class="w-full bg-transparent border-b border-gray-100 dark:border-gray-700 focus:border-blue-500 outline-none text-sm dark:text-gray-200 placeholder-gray-400"
                                onchange="updateItem('${type}', ${index}, 'name', this.value)">
                            ${getAuthorLabel(item)}
                        </div>
                        
                        <div class="flex items-start border-b border-gray-100 dark:border-gray-700 focus-within:border-blue-500">
                            <span class="text-xs text-gray-500 dark:text-gray-400 mr-1 mt-1">R$</span>
                            <input type="number" inputmode="decimal" step="0.01" value="${item.value}" placeholder="0,00" 
                                class="w-full bg-transparent outline-none text-sm font-semibold text-gray-700 dark:text-gray-100 text-right placeholder-gray-400"
                                onchange="updateItem('${type}', ${index}, 'value', parseFloat(this.value))">
                        </div>
                    </div>
                    <div class="z-20 flex flex-col justify-center">
                         <button onclick="deleteItem('${type}', ${index})" class="text-gray-300 dark:text-gray-600 hover:text-red-500 dark:hover:text-red-400 p-2"><i class="fas fa-trash-alt"></i></button>
                    </div>
                </div>
            `;
            return div;
        }

        // 3. CARTÕES
        function renderCardRow(item, index, type) {
            const div = document.createElement('div');
            div.className = "flex items-center gap-0 relative group";
            const isPaid = item.paid;

            div.innerHTML = `
                <input type="checkbox" class="status-checkbox-expense absolute opacity-0 touch-area h-full z-10 cursor-pointer" 
                    ${isPaid ? 'checked' : ''} onchange="updateItem('${type}', ${index}, 'paid', this.checked)">
                
                <div class="flex-1 bg-white dark:bg-gray-800 p-3 rounded shadow-sm border border-gray-100 dark:border-gray-700 transition-colors duration-300 pl-6 flex items-center gap-2">
                     <div class="flex-1 grid grid-cols-3 gap-2">
                        <div class="col-span-2">
                            <input type="text" value="${item.issuer || ''}" placeholder="Nome do Cartão" 
                                class="w-full bg-transparent border-b border-gray-100 dark:border-gray-700 focus:border-purple-500 outline-none text-sm font-medium dark:text-gray-200 placeholder-gray-400"
                                onchange="updateItem('${type}', ${index}, 'issuer', this.value)">
                            ${getAuthorLabel(item)}
                        </div>
                        
                        <div class="flex items-start border-b border-gray-100 dark:border-gray-700 focus-within:border-purple-500">
                            <span class="text-xs text-gray-500 dark:text-gray-400 mr-1 mt-1">R$</span>
                            <input type="number" inputmode="decimal" step="0.01" value="${item.value}" placeholder="0,00" 
                                class="w-full bg-transparent outline-none text-sm font-bold text-gray-700 dark:text-gray-100 text-right placeholder-gray-400"
                                onchange="updateItem('${type}', ${index}, 'value', parseFloat(this.value))">
                        </div>
                     </div>
                     <div class="z-20">
                        <button onclick="deleteItem('${type}', ${index})" class="text-gray-300 dark:text-gray-600 hover:text-red-500 dark:hover:text-red-400 p-2"><i class="fas fa-trash-alt"></i></button>
                     </div>
                </div>
            `;
            return div;
        }

        function calculateTotals() {
            let totalIncome = 0;
            let totalPaid = 0;
            let totalPending = 0;

            currentData.incomes.forEach(i => totalIncome += (i.value || 0));

            const sumExpense = (list) => {
                list.forEach(item => {
                    const val = item.value || 0;
                    if (item.paid) totalPaid += val;
                    else totalPending += val;
                });
            };

            sumExpense(currentData.fixed);
            sumExpense(currentData.cards);
            sumExpense(currentData.general);

            const fmt = (v) => v.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            
            document.getElementById('total-income').textContent = fmt(totalIncome);
            document.getElementById('total-paid').textContent = fmt(totalPaid);
            document.getElementById('total-pending').textContent = fmt(totalPending);
            
            const balance = totalIncome - (totalPaid + totalPending);
            const balEl = document.getElementById('balance');
            balEl.textContent = fmt(balance);
            
            // Lógica de cor do saldo adaptada para dark mode
            if (balance >= 0) {
                balEl.className = "text-xl font-bold text-blue-600 dark:text-blue-400";
            } else {
                balEl.className = "text-xl font-bold text-red-600 dark:text-red-400";
            }
        }

        window.addItem = (type, shouldSave = true) => {
            const newItem = { 
                id: Date.now(), 
                value: 0, 
                paid: false,
                createdBy: currentUser ? (currentUser.displayName || currentUser.email) : 'Anônimo'
            };
            
            if (type === 'incomes') { delete newItem.paid; newItem.name = ''; }
            else if (type === 'cards') { newItem.issuer = ''; }
            else { newItem.name = ''; }
            
            currentData[type].push(newItem);
            if(shouldSave) {
                renderAll();
                saveData();
                
                setTimeout(() => {
                    const container = document.getElementById(`list-${type}`);
                    const lastRow = container.lastElementChild;
                    if (lastRow) {
                        const firstInput = lastRow.querySelector('input[type="text"]');
                        if (firstInput) firstInput.focus();
                    }
                }, 50);
            }
        };

        window.deleteItem = (type, index) => {
            if(confirm("Remover item?")) {
                currentData[type].splice(index, 1);
                renderAll();
                saveData();
            }
        };

        window.updateItem = (type, index, field, value) => {
            currentData[type][index][field] = value;
            if (currentUser) {
                currentData[type][index].lastEditedBy = currentUser.displayName || currentUser.email;
            }
            if(field === 'paid') renderAll(); 
            else calculateTotals(); 
            saveData();
        };

        function saveData() {
            document.getElementById('save-status').innerHTML = '<div class="loader"></div> Salvando...';
            if (saveTimeout) clearTimeout(saveTimeout);
            saveTimeout = setTimeout(async () => {
                if (!currentUser) return;
                const docId = getDocId();
                try {
                    await setDoc(doc(db, 'monthly_data', docId), currentData);
                    document.getElementById('save-status').innerHTML = '<i class="fas fa-check text-green-500"></i> Sincronizado';
                } catch (e) {
                    console.error(e);
                    document.getElementById('save-status').textContent = "Erro ao salvar! (Verifique as regras)";
                }
            }, 1000);
        }
    </script>
</body>
</html>


