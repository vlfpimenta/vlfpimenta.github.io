<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Navegador GPS Pro</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- OSM Buildings -->
    <script src="https://cdn.osmbuildings.org/4.1.1/OSMBuildings.js"></script>

    <style>
        /* --- Estilos Base e Temas --- */
        :root {
            --bg-glass: rgba(30, 41, 59, 0.90);
            --border-glass: rgba(255, 255, 255, 0.1);
            --text-primary: white;
            --text-secondary: #94a3b8;
            --btn-hover: rgba(255,255,255,0.1);
        }
        body.light-mode {
            --bg-glass: rgba(255, 255, 255, 0.95);
            --border-glass: rgba(0, 0, 0, 0.1);
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --btn-hover: rgba(0,0,0,0.05);
        }

        body, html { margin: 0; padding: 0; height: 100%; width: 100%; overflow: hidden; font-family: system-ui, sans-serif; touch-action: none; }
        
        /* AJUSTE DE VIEWPORT EXTENDIDA 
           Aumentamos o container para 200% e centralizamos com top/left -50%.
           Isso garante que ao aplicar rotateX, as bordas n칚o apare칞am.
        */
        #map-container { 
            position: absolute; 
            top: -50%; 
            left: -50%; 
            width: 200%; 
            height: 200%; 
            z-index: 0; 
            transition: transform 1s; 
        }

        .glass-panel {
            background: var(--bg-glass);
            backdrop-filter: blur(12px);
            border-radius: 16px;
            border: 1px solid var(--border-glass);
            color: var(--text-primary);
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
            transition: all 0.3s;
        }

        /* Widget de Clima */
        #weather-widget { animation: slideDown 0.5s ease-out; }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

        /* Bot칫es */
        .btn-icon {
            width: 48px; height: 48px; display: flex; align-items: center; justify-content: center;
            border-radius: 50%; cursor: pointer; transition: transform 0.2s, background 0.2s;
            background: var(--bg-glass); border: 1px solid var(--border-glass); color: var(--text-primary);
        }
        .btn-icon:hover { transform: scale(1.1); background: var(--btn-hover); }
        .btn-active { color: #3b82f6; border-color: #3b82f6; background: rgba(59, 130, 246, 0.2); }
        .btn-traffic-active { color: #ef4444; border-color: #ef4444; background: rgba(239, 68, 68, 0.2); }

        /* Leaflet Customizations */
        .leaflet-popup-content-wrapper { background: var(--bg-glass); color: var(--text-primary); border-radius: 12px; backdrop-filter: blur(5px); }
        .leaflet-popup-tip { background: var(--bg-glass); }
        .leaflet-popup-content { margin: 12px; font-size: 14px; line-height: 1.4; }
        .leaflet-container a.leaflet-popup-close-button { color: var(--text-secondary); }
        .leaflet-routing-container { display: none !important; }

        /* Feedback visual do toque longo */
        .long-press-animation {
            position: absolute; border-radius: 50%; background: rgba(59, 130, 246, 0.5);
            animation: ripple 0.8s ease-out forwards; pointer-events: none; z-index: 1000;
        }
        @keyframes ripple { 0% { width: 0; height: 0; opacity: 1; } 100% { width: 100px; height: 100px; opacity: 0; margin-left: -50px; margin-top: -50px; } }
    </style>
</head>
<body class="bg-slate-900 transition-colors duration-500">

    <div id="map-container">
        <div id="map" class="w-full h-full"></div>
    </div>

    <!-- Busca -->
    <div class="absolute top-4 left-4 right-4 z-20 flex justify-center pointer-events-none">
        <div class="glass-panel w-full max-w-md p-2 flex items-center gap-2 pointer-events-auto">
            <i class="fa-solid fa-location-dot text-blue-500 ml-2"></i>
            <input type="text" id="search-input" placeholder="Busca..." class="w-full bg-transparent border-none outline-none h-10 px-2">
            <button onclick="searchLocation()" class="w-10 h-10 rounded-xl bg-blue-600 text-white flex items-center justify-center hover:bg-blue-700">
                <i class="fa-solid fa-magnifying-glass"></i>
            </button>
        </div>
    </div>

    <!-- Widget Clima -->
    <div id="weather-widget" class="absolute top-20 left-4 z-20 glass-panel px-4 py-3 hidden pointer-events-auto flex items-center gap-3" title="Clima local">
        <div id="weather-icon" class="text-2xl text-yellow-400 w-8 text-center"><i class="fa-solid fa-spinner fa-spin"></i></div>
        <div class="flex flex-col">
            <div id="weather-temp" class="font-bold text-xl leading-none">--춿C</div>
            <div id="weather-desc" class="text-[10px] opacity-70 uppercase font-bold mt-1">...</div>
        </div>
    </div>

    <!-- Controles Direita -->
    <div class="absolute right-4 top-24 z-20 flex flex-col gap-3 pointer-events-auto">
        <button onclick="toggleTheme()" class="btn-icon" title="Alternar Tema"><i class="fa-solid fa-moon" id="icon-theme"></i></button>
        <button onclick="toggle3D()" id="btn-3d" class="btn-icon" title="Vis칚o 3D"><i class="fa-solid fa-cubes-stacked"></i></button>
        <button onclick="toggleTrafficLayer()" id="btn-traffic" class="btn-icon" title="Mostrar Tr칙nsito"><i class="fa-solid fa-road"></i></button>
        <button onclick="locateUser(true)" class="btn-icon text-green-500" title="Meu Local"><i class="fa-solid fa-crosshairs"></i></button>
        <div class="glass-panel w-12 h-16 flex flex-col items-center justify-center text-xs font-mono mt-2">
            <div id="speed-val" class="text-lg font-bold">0</div><div class="text-[9px] text-gray-400">km/h</div>
        </div>
    </div>

    <!-- Painel de Rota -->
    <div id="nav-panel" class="absolute bottom-8 left-4 right-4 z-20 hidden pointer-events-none flex justify-center">
        <div class="glass-panel p-4 pointer-events-auto w-full max-w-lg flex flex-col gap-3">
            <div class="flex justify-between items-center border-b border-gray-500/20 pb-2">
                <div class="flex gap-4 text-center">
                    <div><div class="text-[10px] uppercase opacity-60">Tempo</div><div id="route-time" class="font-bold text-lg">--</div></div>
                    <div><div class="text-[10px] uppercase opacity-60">Dist칙ncia</div><div id="route-dist" class="font-bold text-lg text-blue-500">--</div></div>
                </div>
                <button onclick="clearRoute()" class="text-red-500 p-2"><i class="fa-solid fa-times text-xl"></i></button>
            </div>
            <div class="text-sm italic opacity-70 flex items-center gap-2 justify-center">
                <i class="fa-solid fa-route"></i> Rota calculada
            </div>
        </div>
    </div>

    <div id="toast-container" class="absolute top-20 left-1/2 transform -translate-x-1/2 z-50 flex flex-col items-center gap-2 w-full max-w-xs pointer-events-none"></div>

    <!-- Scripts -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>
    
    <script>
        const TILES = {
            DARK: 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',
            LIGHT: 'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png'
        };
        
        let map, baseLayer, trafficLayer, routingControl, osmb;
        // Marcadores de Pontos
        let currentPosMarker = null; // Localiza칞칚o GPS
        let startMarker = null;      // Ponto A (Verde)
        let endMarker = null;        // Ponto B (Vermelho)
        
        let pressTimer, isLongPress = false;
        let state = { is3D: false, isTraffic: false, isLightMode: false };

        // 칈cones
        const icons = {
            user: L.divIcon({className:'bg-transparent', html:'<div class="relative"><div class="absolute -top-3 -left-3 w-10 h-10 border-4 border-blue-500 rounded-full opacity-50 animate-ping"></div><div class="w-4 h-4 bg-blue-500 border-2 border-white rounded-full shadow"></div></div>'}),
            start: L.divIcon({html:'<i class="fa-solid fa-location-dot text-green-500 text-3xl drop-shadow-lg"></i>', className:'bg-transparent', iconAnchor:[7,32]}),
            end: L.divIcon({html:'<i class="fa-solid fa-location-dot text-red-500 text-3xl drop-shadow-lg"></i>', className:'bg-transparent', iconAnchor:[7,32]})
        };

        window.onload = () => {
            map = L.map('map', { zoomControl: false, attributionControl: false }).setView([-23.5505, -46.6333], 15);
            baseLayer = L.tileLayer(TILES.DARK, { maxZoom: 20 }).addTo(map);
            
            // Camada de Tr치fego do Google (Hack URL)
            trafficLayer = L.tileLayer('https://mt0.google.com/vt?lyrs=h@159000000,traffic|seconds_into_week:-1&style=3&x={x}&y={y}&z={z}', {
                maxZoom: 20,
                opacity: 1
            });

            locateUser(false);
            initMapInteractions();
        };

        // --- INTERA칂칏ES E POPUPS ---

        function initMapInteractions() {
            // L칩gica de Long Press
            map.on('mousedown touchstart', function(e) {
                isLongPress = false;
                pressTimer = setTimeout(() => { isLongPress = true; handleLongPress(e); }, 800);
            });
            map.on('movestart dragstart mouseup touchend', () => clearTimeout(pressTimer));

            map.on('click', (e) => { if (!isLongPress) handleShortClick(e); });
            map.on('contextmenu', handleLongPress);
        }

        async function handleShortClick(e) {
            const popup = L.popup().setLatLng(e.latlng).setContent('<div class="text-center"><i class="fa-solid fa-spinner fa-spin text-blue-500"></i>...</div>').openOn(map);

            try {
                const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${e.latlng.lat}&lon=${e.latlng.lng}`);
                const data = await res.json();
                const title = data.address.road || data.address.suburb || "Local Selecionado";
                
                const content = `
                    <div class="flex flex-col gap-2 min-w-[220px]">
                        <div class="mb-1">
                            <div class="font-bold text-base text-blue-400">${title}</div>
                            <div class="text-xs text-gray-400 border-t border-gray-600 pt-1 mt-1 truncate">${data.display_name}</div>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="setOriginFromPopup(${e.latlng.lat}, ${e.latlng.lng})" 
                                class="flex-1 bg-green-600/80 hover:bg-green-700 text-white text-xs py-2 rounded-lg flex flex-col items-center justify-center gap-1 transition">
                                <i class="fa-solid fa-play"></i> <span>Partir daqui</span>
                            </button>
                            <button onclick="setDestinationFromPopup(${e.latlng.lat}, ${e.latlng.lng})" 
                                class="flex-1 bg-red-600/80 hover:bg-red-700 text-white text-xs py-2 rounded-lg flex flex-col items-center justify-center gap-1 transition">
                                <i class="fa-solid fa-flag-checkered"></i> <span>Ir para c치</span>
                            </button>
                        </div>
                    </div>
                `;
                popup.setContent(content);
            } catch(err) { popup.setContent('<div class="text-red-400">Erro endere칞o.</div>'); }
        }

        function handleLongPress(e) {
            if (navigator.vibrate) navigator.vibrate(50);
            const r = document.createElement('div'); r.className = 'long-press-animation'; 
            r.style.left = e.containerPoint.x + 'px'; r.style.top = e.containerPoint.y + 'px';
            document.getElementById('map-container').appendChild(r); setTimeout(() => r.remove(), 1000);
            
            // Atalho: Long Press define Destino direto
            setDestinationFromPopup(e.latlng.lat, e.latlng.lng);
        }

        // --- DEFINI칂츾O DE PONTOS (ORIGEM / DESTINO) ---

        window.setOriginFromPopup = function(lat, lng) {
            map.closePopup();
            const ll = L.latLng(lat, lng);
            
            if(startMarker) map.removeLayer(startMarker);
            startMarker = L.marker(ll, {icon: icons.start}).addTo(map);
            
            checkRoute();
            showToast("游늸 Ponto de partida definido");
        };

        window.setDestinationFromPopup = function(lat, lng) {
            map.closePopup();
            const ll = L.latLng(lat, lng);
            
            if(endMarker) map.removeLayer(endMarker);
            endMarker = L.marker(ll, {icon: icons.end}).addTo(map);
            
            checkRoute();
            showToast("游끠 Destino definido");
        };

        function checkRoute() {
            // Se tem destino mas n칚o tem origem manual, usa GPS como origem
            if(endMarker && !startMarker && currentPosMarker) {
                calculateRoute(currentPosMarker.getLatLng(), endMarker.getLatLng());
            }
            // Se tem os dois manuais
            else if(startMarker && endMarker) {
                calculateRoute(startMarker.getLatLng(), endMarker.getLatLng());
            }
        }

        function calculateRoute(start, end) {
            if(routingControl) map.removeControl(routingControl);
            document.getElementById('nav-panel').classList.remove('hidden');
            document.getElementById('route-dist').innerText = "...";

            routingControl = L.Routing.control({
                waypoints: [start, end],
                router: L.Routing.osrmv1({ serviceUrl: 'https://router.project-osrm.org/route/v1' }),
                lineOptions: { styles: [{color: '#3b82f6', weight: 6, opacity: 0.8}] },
                createMarker: () => null, // Remove marcadores padr칚o do routing (usamos os nossos)
                addWaypoints: false
            }).on('routesfound', e => {
                const r = e.routes[0];
                document.getElementById('route-dist').innerText = `${(r.summary.totalDistance/1000).toFixed(1)} km`;
                document.getElementById('route-time').innerText = `${Math.round(r.summary.totalTime/60)} min`;
            }).addTo(map);
        }

        function clearRoute() {
            if(routingControl) map.removeControl(routingControl);
            if(startMarker) map.removeLayer(startMarker); startMarker = null;
            if(endMarker) map.removeLayer(endMarker); endMarker = null;
            document.getElementById('nav-panel').classList.add('hidden');
            document.getElementById('search-input').value = '';
        }

        // --- FUNCIONALIDADES EXTRAS ---

        function toggleTrafficLayer() {
            state.isTraffic = !state.isTraffic;
            const btn = document.getElementById('btn-traffic');
            
            if(state.isTraffic) {
                btn.classList.add('btn-traffic-active');
                map.addLayer(trafficLayer);
                showToast("Tr칙nsito ativado (Google Layer)");
            } else {
                btn.classList.remove('btn-traffic-active');
                map.removeLayer(trafficLayer);
            }
        }

        function toggleTheme() {
            state.isLightMode = !state.isLightMode;
            document.body.className = state.isLightMode ? 'light-mode bg-gray-100' : 'bg-slate-900';
            document.getElementById('icon-theme').className = state.isLightMode ? 'fa-solid fa-sun' : 'fa-solid fa-moon';
            baseLayer.setUrl(state.isLightMode ? TILES.LIGHT : TILES.DARK);
        }

        function toggle3D() {
            state.is3D = !state.is3D;
            const btn = document.getElementById('btn-3d');
            if(state.is3D) {
                btn.classList.add('btn-active');
                document.getElementById('map-container').style.transform = "perspective(800px) rotateX(35deg)";
                if(!osmb) osmb = new OSMBuildings(map).load('https://{s}.data.osmbuildings.org/0.2/59fcc2e8/tile/{z}/{x}/{y}.json');
                osmb.show();
            } else {
                btn.classList.remove('btn-active');
                document.getElementById('map-container').style.transform = "none";
                if(osmb) osmb.hide();
            }
        }

        // --- GPS & BUSCA ---

        function locateUser(isManual) {
            if(isManual) showToast("Buscando GPS...");
            navigator.geolocation ? navigator.geolocation.getCurrentPosition(p => updateUserPosition(p.coords.latitude, p.coords.longitude, isManual), () => locateByIP(isManual)) : locateByIP(isManual);
        }

        async function locateByIP(isManual) {
            try {
                const res = await fetch('https://get.geojs.io/v1/ip/geo.json');
                const data = await res.json();
                updateUserPosition(parseFloat(data.latitude), parseFloat(data.longitude), isManual);
            } catch(e) { showToast("Erro localiza칞칚o"); }
        }

        function updateUserPosition(lat, lng, isManual) {
            const ll = [lat, lng];
            if(!currentPosMarker) {
                currentPosMarker = L.marker(ll, {icon: icons.user}).addTo(map);
            } else currentPosMarker.setLatLng(ll);
            
            map.flyTo(ll, 16);
            fetchWeather(lat, lng);
            if(isManual) showToast("Localizado!");
        }

        async function fetchWeather(lat, lng) {
            document.getElementById('weather-widget').classList.remove('hidden');
            try {
                const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lng}&current_weather=true`);
                const data = await res.json();
                if(data.current_weather) {
                    const t = Math.round(data.current_weather.temperature);
                    const c = data.current_weather.weathercode;
                    document.getElementById('weather-temp').innerText = `${t}춿C`;
                    let i="fa-sun", d="Sol", cl="text-yellow-400";
                    if(c>3) { i="fa-cloud"; d="Nublado"; cl="text-gray-400"; }
                    if(c>50) { i="fa-cloud-rain"; d="Chuva"; cl="text-blue-400"; }
                    document.getElementById('weather-icon').innerHTML = `<i class="fa-solid ${i}"></i>`;
                    document.getElementById('weather-icon').className = `text-2xl w-8 text-center ${cl}`;
                    document.getElementById('weather-desc').innerText = d;
                }
            } catch(e) {}
        }

        async function searchLocation() { 
            const q=document.getElementById('search-input').value; 
            if(!q) return; 
            const res=await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}`); 
            const data=await res.json(); 
            if(data.length) setDestinationFromPopup(data[0].lat, data[0].lon); 
        }

        function showToast(msg) { 
            const t=document.createElement('div'); 
            t.className="bg-black/80 text-white px-4 py-2 rounded-lg shadow border-l-4 border-blue-500 text-sm mb-2 pointer-events-auto"; 
            t.innerText=msg; 
            document.getElementById('toast-container').appendChild(t); 
            setTimeout(()=>t.remove(), 3000); 
        }
    </script>
</body>
</html>


